#!/usr/bin/env node
/**
 * Deployment Readiness Test Script
 * Comprehensive test to ensure LayerEdge platform is ready for deployment
 * with X API integration and enhanced fallback chain
 */

require('dotenv').config()

const TARGET_TWEET_URL = 'https://x.com/nxrsultxn/status/1931733077400641998'
const TARGET_USERNAME = 'nxrsultxn'

async function testDependencyInstallation() {
  console.log('üì¶ DEPENDENCY INSTALLATION TEST')
  console.log('‚îÄ'.repeat(50))
  
  try {
    // Test twitter-api-v2 import
    console.log('Testing twitter-api-v2 import...')
    const { TwitterApi } = require('twitter-api-v2')
    console.log('‚úÖ twitter-api-v2 imported successfully')
    
    // Test X API service import
    console.log('Testing X API service import...')
    const { XApiService, getXApiService } = require('../src/lib/x-api-service')
    console.log('‚úÖ X API service imported successfully')
    
    // Test fallback service import
    console.log('Testing fallback service import...')
    const { FallbackService } = require('../src/lib/fallback-service')
    console.log('‚úÖ Fallback service imported successfully')
    
    return true
  } catch (error) {
    console.log(`‚ùå Dependency test failed: ${error.message}`)
    return false
  }
}

async function testEnvironmentConfiguration() {
  console.log('\nüîß ENVIRONMENT CONFIGURATION TEST')
  console.log('‚îÄ'.repeat(50))
  
  const requiredVars = {
    'TWITTER_API_KEY': 'cEDodIuWbGdMynFSunnxdFJVS',
    'TWITTER_API_SECRET': 'xGpwmVssQSROioYSpt0PQULMtC18kAslMwh2qbCoRlPZakdRES'
  }
  
  let allCorrect = true
  
  for (const [varName, expectedValue] of Object.entries(requiredVars)) {
    const actualValue = process.env[varName]
    
    if (!actualValue) {
      console.log(`‚ùå ${varName}: MISSING`)
      allCorrect = false
    } else if (actualValue !== expectedValue) {
      console.log(`‚ùå ${varName}: INCORRECT`)
      console.log(`   Expected: ${expectedValue}`)
      console.log(`   Actual: ${actualValue}`)
      allCorrect = false
    } else {
      console.log(`‚úÖ ${varName}: CORRECT`)
    }
  }
  
  return allCorrect
}

async function testXApiService() {
  console.log('\nüîë X API SERVICE TEST')
  console.log('‚îÄ'.repeat(50))
  
  try {
    const { getXApiService } = require('../src/lib/x-api-service')
    const xApiService = getXApiService()
    
    // Test service status
    const status = xApiService.getStatus()
    console.log('üìä X API Service Status:')
    console.log(`   Authenticated: ${status.authenticated}`)
    console.log(`   API Key: ${status.apiKey}`)
    console.log(`   Ready: ${status.ready}`)
    
    if (!status.ready) {
      console.log('‚ùå X API service not ready')
      return false
    }
    
    // Test connection
    console.log('Testing X API connection...')
    const connectionTest = await xApiService.verifyConnection()
    
    if (connectionTest) {
      console.log('‚úÖ X API connection successful')
    } else {
      console.log('‚ùå X API connection failed')
      return false
    }
    
    // Test user lookup
    console.log(`Testing user lookup for @${TARGET_USERNAME}...`)
    const userResult = await xApiService.verifyUserLogin(TARGET_USERNAME)
    
    if (userResult.success) {
      console.log('‚úÖ User lookup successful')
      console.log(`   User: @${userResult.user.username} (${userResult.user.name})`)
      console.log(`   Followers: ${userResult.user.followersCount.toLocaleString()}`)
    } else {
      console.log(`‚ùå User lookup failed: ${userResult.error}`)
      return false
    }
    
    return true
  } catch (error) {
    console.log(`‚ùå X API service test failed: ${error.message}`)
    return false
  }
}

async function testEnhancedFallbackChain() {
  console.log('\nüîÑ ENHANCED FALLBACK CHAIN TEST')
  console.log('‚îÄ'.repeat(50))
  
  try {
    const { FallbackService } = require('../src/lib/fallback-service')
    
    // Test with X API priority
    const fallbackService = new FallbackService({
      preferApi: true,
      enableScweet: true,
      enableTwikit: true,
      enableScraping: true
    })
    
    console.log(`Testing fallback chain with target tweet: ${TARGET_TWEET_URL}`)
    
    const startTime = Date.now()
    const result = await fallbackService.getTweetData(TARGET_TWEET_URL)
    const fetchTime = Date.now() - startTime
    
    if (result) {
      console.log('‚úÖ Fallback chain successful!')
      console.log(`   Source: ${result.source.toUpperCase()}`)
      console.log(`   Content: ${result.content.substring(0, 80)}...`)
      console.log(`   Author: @${result.author.username}`)
      console.log(`   Engagement: ${result.likes} likes, ${result.retweets} retweets`)
      console.log(`   Fetch Time: ${fetchTime}ms`)
      console.log(`   LayerEdge Community: ${result.isFromLayerEdgeCommunity}`)
      
      // Verify it's from the correct user
      if (result.author.username.toLowerCase() === TARGET_USERNAME.toLowerCase()) {
        console.log('‚úÖ Correct user verified')
        return true
      } else {
        console.log(`‚ùå Wrong user: expected @${TARGET_USERNAME}, got @${result.author.username}`)
        return false
      }
    } else {
      console.log('‚ùå Fallback chain failed - no data returned')
      return false
    }
  } catch (error) {
    console.log(`‚ùå Fallback chain test failed: ${error.message}`)
    return false
  }
}

async function testBuildProcess() {
  console.log('\nüèóÔ∏è BUILD PROCESS TEST')
  console.log('‚îÄ'.repeat(50))
  
  try {
    const { spawn } = require('child_process')
    
    console.log('Testing Next.js build process...')
    
    return new Promise((resolve) => {
      const buildProcess = spawn('npm', ['run', 'build'], {
        stdio: 'pipe',
        shell: true
      })
      
      let buildOutput = ''
      let buildError = ''
      
      buildProcess.stdout.on('data', (data) => {
        buildOutput += data.toString()
      })
      
      buildProcess.stderr.on('data', (data) => {
        buildError += data.toString()
      })
      
      buildProcess.on('close', (code) => {
        if (code === 0) {
          console.log('‚úÖ Build process completed successfully')
          console.log('‚úÖ No twitter-api-v2 dependency errors')
          resolve(true)
        } else {
          console.log('‚ùå Build process failed')
          console.log('Build Error Output:')
          console.log(buildError)
          
          if (buildError.includes('twitter-api-v2')) {
            console.log('‚ùå twitter-api-v2 dependency issue detected')
          }
          
          resolve(false)
        }
      })
      
      // Timeout after 2 minutes
      setTimeout(() => {
        buildProcess.kill()
        console.log('‚ùå Build process timed out')
        resolve(false)
      }, 120000)
    })
  } catch (error) {
    console.log(`‚ùå Build test failed: ${error.message}`)
    return false
  }
}

async function testAPIEndpoints() {
  console.log('\nüåê API ENDPOINTS TEST')
  console.log('‚îÄ'.repeat(50))
  
  try {
    // Start the application for testing
    const { spawn } = require('child_process')
    
    console.log('Starting application for API testing...')
    
    const appProcess = spawn('npm', ['run', 'dev'], {
      stdio: 'pipe',
      shell: true
    })
    
    // Wait for app to start
    await new Promise(resolve => setTimeout(resolve, 10000))
    
    try {
      // Test X API login endpoint
      console.log('Testing X API login endpoint...')
      const loginResponse = await fetch('http://localhost:3000/api/x-api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: TARGET_USERNAME })
      })
      
      if (loginResponse.ok) {
        const loginData = await loginResponse.json()
        if (loginData.success) {
          console.log('‚úÖ X API login endpoint working')
        } else {
          console.log('‚ùå X API login endpoint failed')
        }
      } else {
        console.log(`‚ùå X API login endpoint returned ${loginResponse.status}`)
      }
      
      // Test X API tweet endpoint
      console.log('Testing X API tweet endpoint...')
      const tweetResponse = await fetch('http://localhost:3000/api/x-api/tweet', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tweetUrl: TARGET_TWEET_URL })
      })
      
      if (tweetResponse.ok) {
        const tweetData = await tweetResponse.json()
        if (tweetData.success) {
          console.log('‚úÖ X API tweet endpoint working')
        } else {
          console.log('‚ùå X API tweet endpoint failed')
        }
      } else {
        console.log(`‚ùå X API tweet endpoint returned ${tweetResponse.status}`)
      }
      
      appProcess.kill()
      return true
    } catch (error) {
      appProcess.kill()
      console.log(`‚ùå API endpoint test failed: ${error.message}`)
      return false
    }
  } catch (error) {
    console.log(`‚ùå API endpoint test setup failed: ${error.message}`)
    return false
  }
}

async function generateDeploymentReport() {
  console.log('üìã DEPLOYMENT READINESS REPORT')
  console.log('=' .repeat(60))
  
  const results = {
    dependencies: await testDependencyInstallation(),
    environment: await testEnvironmentConfiguration(),
    xApiService: await testXApiService(),
    fallbackChain: await testEnhancedFallbackChain(),
    buildProcess: await testBuildProcess()
    // Note: Skipping API endpoints test for now as it requires app to be running
  }
  
  console.log('\nüìä DEPLOYMENT READINESS SUMMARY')
  console.log('=' .repeat(60))
  
  console.log('üîß Core Components:')
  console.log(`   ‚úÖ Dependencies: ${results.dependencies ? 'READY' : 'FAILED'}`)
  console.log(`   ‚úÖ Environment: ${results.environment ? 'READY' : 'FAILED'}`)
  console.log(`   ‚úÖ X API Service: ${results.xApiService ? 'READY' : 'FAILED'}`)
  console.log(`   ‚úÖ Fallback Chain: ${results.fallbackChain ? 'READY' : 'FAILED'}`)
  console.log(`   ‚úÖ Build Process: ${results.buildProcess ? 'READY' : 'FAILED'}`)
  
  const allReady = Object.values(results).every(Boolean)
  
  if (allReady) {
    console.log('\nüéâ DEPLOYMENT READY!')
    console.log('‚úÖ All systems operational')
    console.log('‚úÖ twitter-api-v2 dependency resolved')
    console.log('‚úÖ X API credentials working')
    console.log('‚úÖ Enhanced fallback chain functional')
    console.log('‚úÖ Build process successful')
    console.log('')
    console.log('üéØ Ready for production deployment!')
  } else {
    console.log('\n‚ö†Ô∏è DEPLOYMENT NOT READY')
    console.log('‚ùå Some components failed testing')
    console.log('üí° Fix the failed components before deploying')
  }
  
  console.log('\nüìã Next Steps:')
  if (allReady) {
    console.log('1. Deploy to production environment')
    console.log('2. Monitor application startup')
    console.log('3. Test X API functionality in production')
    console.log('4. Verify target tweet can be processed')
  } else {
    console.log('1. Fix failed components listed above')
    console.log('2. Re-run deployment readiness test')
    console.log('3. Ensure all dependencies are installed')
    console.log('4. Verify environment configuration')
  }
  
  return allReady
}

// Main execution
async function main() {
  console.log('üöÄ LayerEdge Deployment Readiness Test')
  console.log('üîë X API Key: cEDodIuWbGdMynFSunnxdFJVS')
  console.log('üë§ Target User: @nxrsultxn')
  console.log('üê¶ Target Tweet: https://x.com/nxrsultxn/status/1931733077400641998')
  console.log('')
  
  const success = await generateDeploymentReport()
  
  console.log('\nüèÅ Deployment readiness test completed!')
  process.exit(success ? 0 : 1)
}

// Handle command line execution
if (require.main === module) {
  main().catch(error => {
    console.error('üí• Deployment readiness test failed:', error)
    process.exit(1)
  })
}

module.exports = {
  testDependencyInstallation,
  testEnvironmentConfiguration,
  testXApiService,
  testEnhancedFallbackChain,
  testBuildProcess
}
